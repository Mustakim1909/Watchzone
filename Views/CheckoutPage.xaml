<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Watchzone.Converters"
             x:Class="Watchzone.Views.CheckoutPage"
             Title="Checkout"
             BackgroundColor="#F1F2F6">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:DefaultCountryConverter x:Key="DefaultCountryConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="20">

            <!-- Shipping Address -->
            <Frame Padding="15" CornerRadius="12" HasShadow="True" BackgroundColor="White">
                <VerticalStackLayout Spacing="12">
                    <Label Text="📦 Shipping Address" FontSize="18" FontAttributes="Bold" TextColor="#222"/>
                    <BoxView HeightRequest="1" Color="#E5E5E5"/>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Entry Grid.Column="0" Placeholder="First Name" Text="{Binding ShippingAddress.FirstName}" />
                        <Entry Grid.Column="1" Placeholder="Last Name" Text="{Binding ShippingAddress.LastName}" />
                    </Grid>

                    <Entry Placeholder="Mobile Number" Text="{Binding ShippingAddress.Phone}" Keyboard="Telephone"/>
                    <Entry Placeholder="Street Address" Text="{Binding ShippingAddress.Address1}" />
                    <Entry Placeholder="Apartment, suite, etc. (optional)" Text="{Binding ShippingAddress.Address2}" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Entry Grid.Column="0" Placeholder="City" Text="{Binding ShippingAddress.City}" />
                        <Entry Grid.Column="1" Placeholder="State" Text="{Binding ShippingAddress.State}" />
                    </Grid>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Entry Grid.Column="0" Placeholder="Postal Code" Text="{Binding ShippingAddress.Postcode}" />
                        <Entry Grid.Column="1" Placeholder="Country"
                   Text="{Binding ShippingAddress.Country, Converter={StaticResource DefaultCountryConverter}}" />
                    </Grid>

                    <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                        <CheckBox 
        IsChecked="{Binding SaveShippingAddress}" 
        Color="#FF9900"
        CheckedChanged="CheckBox_CheckedChanged"/>
                        <Label Text="Save this address for future purchases" 
           FontSize="14" VerticalOptions="Center"/>
                    </HorizontalStackLayout>

                </VerticalStackLayout>
            </Frame>


            <!-- Payment Method -->
            <Frame Padding="15" CornerRadius="12" HasShadow="True" BackgroundColor="White">
                <VerticalStackLayout Spacing="12">
                    <Label Text="💳 Payment Method" FontSize="18" FontAttributes="Bold" TextColor="#222"/>
                    <BoxView HeightRequest="1" Color="#E5E5E5"/>

                    <RadioButton Content="Cash on Delivery" Value="COD" GroupName="PaymentMethod" IsChecked="True"/>

                </VerticalStackLayout>
            </Frame>

            <!-- Order Summary -->
            <Frame Padding="15" CornerRadius="12" HasShadow="True" BackgroundColor="White">
                <VerticalStackLayout Spacing="12">
                    <Label Text="🛒 Order Summary" FontSize="18" FontAttributes="Bold" TextColor="#222"/>
                    <BoxView HeightRequest="1" Color="#E5E5E5"/>

                    <CollectionView ItemsSource="{Binding CartItems}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="60,*,Auto" Padding="0,8" RowSpacing="5">
                                    <Image Grid.Column="0" Source="{Binding Product.Images[0].Src}"
                                           Aspect="AspectFill" HeightRequest="50" WidthRequest="50"
                                           BackgroundColor="#FAFAFA" Margin="0,0,10,0"/>

                                    <VerticalStackLayout Grid.Column="1" Spacing="2">
                                        <Label Text="{Binding Product.Name}" FontSize="14" MaxLines="1"
                                               LineBreakMode="TailTruncation" TextColor="#333"/>
                                        <Label Text="{Binding Quantity, StringFormat='Qty: {0}'}" FontSize="12" TextColor="#666"/>
                                    </VerticalStackLayout>

                                    <Label Grid.Column="2" Text="{Binding TotalPrice, StringFormat='₹{0:F2}'}"
                                           FontSize="14" FontAttributes="Bold" TextColor="#000"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <BoxView HeightRequest="1" Color="#E5E5E5"/>

                    <!-- Price Breakdown -->
                    <VerticalStackLayout Spacing="12" Padding="5,0">

                        <!-- Subtotal -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Subtotal" FontSize="14" TextColor="#666" Grid.Column="0"/>
                            <Label Text="{Binding Subtotal, StringFormat='₹{0:F2}'}" 
               FontSize="14" TextColor="#111" Grid.Column="1"/>
                        </Grid>

                        <!-- Shipping -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Shipping" FontSize="14" TextColor="#666" Grid.Column="0"/>
                            <Label Text="{Binding ShippingCost, StringFormat='₹{0:F2}'}" 
               FontSize="14" TextColor="#111" Grid.Column="1"/>
                        </Grid>

                        <!-- Tax -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Tax" FontSize="14" TextColor="#666" Grid.Column="0"/>
                            <Label Text="{Binding TaxAmount, StringFormat='₹{0:F2}'}" 
               FontSize="14" TextColor="#111" Grid.Column="1"/>
                        </Grid>

                        <!-- Discount -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Discount" FontSize="14" TextColor="#666" Grid.Column="0"/>
                            <Label Text="{Binding DiscountAmount, StringFormat='-₹{0:F2}'}"
               FontSize="14" FontAttributes="Bold" TextColor="Green" Grid.Column="1"/>
                        </Grid>

                        <!-- Divider -->
                        <BoxView HeightRequest="1" Color="#E5E5E5" Margin="0,5"/>

                        <!-- Total -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Total" FontSize="16" FontAttributes="Bold" Grid.Column="0"/>
                            <Label Text="{Binding Total, StringFormat='₹{0:F2}'}"
               FontSize="18" FontAttributes="Bold"
               TextColor="#FF9900" Grid.Column="1"/>
                        </Grid>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Coupon Section -->
            <Frame Padding="15" CornerRadius="12" HasShadow="True" BackgroundColor="White">
                <VerticalStackLayout Spacing="12">
                    <Label Text="🎁 Apply Coupon" FontSize="18" FontAttributes="Bold" TextColor="#222"/>

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                        <!-- Coupon Input -->
                        <Entry Grid.Column="0"
                   Placeholder="Enter coupon code"
                   Text="{Binding CouponCode}" 
                   HorizontalOptions="FillAndExpand"/>

                        <!-- Apply Button aligned right -->
                        <Button Grid.Column="1"
                    Text="Apply"
                    Command="{Binding ApplyCouponCommand}"
                    BackgroundColor="#FF9900"
                    TextColor="White"
                    CornerRadius="8"
                    FontAttributes="Bold"
                    MinimumWidthRequest="90"/>
                    </Grid>

                    <!-- Remove Coupon -->
                    <Button Text="Remove Coupon"
                Command="{Binding RemoveCouponCommand}"
                IsVisible="{Binding IsCouponApplied}"
                TextColor="Red"
                BackgroundColor="Transparent"
                BorderColor="Red"
                BorderWidth="1"
                CornerRadius="8"/>
                </VerticalStackLayout>
            </Frame>


            <!-- Place Order Button -->
            <Grid ColumnDefinitions="*,2*" ColumnSpacing="15" Margin="0,10">
                <VerticalStackLayout Grid.Column="0">
                    <Label Text="Total Amount" FontSize="14" TextColor="#666"/>
                    <Label Text="{Binding Total, StringFormat='₹{0:F2}'}"
                           FontSize="20" FontAttributes="Bold" TextColor="#FF9900"/>
                </VerticalStackLayout>

                <Button Grid.Column="1" Text="Place Order" Command="{Binding PlaceOrderCommand}"
                        BackgroundColor="#FF9900" TextColor="White"
                        FontSize="16" HeightRequest="55" CornerRadius="12" FontAttributes="Bold"/>
            </Grid>

        </VerticalStackLayout>
        
    </ScrollView>
</ContentPage>
