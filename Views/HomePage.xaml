<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Watchzone.ViewModels"
             x:Class="Watchzone.Views.HomePage"
             Shell.TabBarIsVisible="True"
             BackgroundColor="{AppThemeBinding Light=#F5F5F7, Dark=#1C1C1E}">

    <ContentPage.BindingContext>
        <vm:MainViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="*,Auto" ColumnDefinitions="*">

        <!-- Full Scrollable Page -->
        <RefreshView Grid.Row="0"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding LoadProductsCommand}">
            <ContentView Padding="10,0">
                <CollectionView ItemsSource="{Binding Products}"
                                SelectionMode="None">

                    <!-- Header: Welcome + Search + Banner -->
                    <CollectionView.Header>
                        <VerticalStackLayout Spacing="0" Padding="0">

                            <!-- Header -->
                            <Grid Padding="10,10,0,5"
                                  ColumnDefinitions="*,Auto">
                                <Label Text="{Binding WelcomeMessage}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />

                                <ImageButton Grid.Column="1"
                                             Source="cart.png"
                                             BackgroundColor="Transparent"
                                             HeightRequest="30"
                                             WidthRequest="30"
                                             HorizontalOptions="End"
                                             VerticalOptions="Center"
                                             Clicked="OnCartClicked" />
                            </Grid>

                            <!-- Search bar -->
                            <SearchBar Placeholder="Search products..."
                                      
                                       SearchButtonPressed="OnSearchButtonPressed" 
                                       Margin="0,20,0,0"/>

                            <!-- Promo banner -->
                            <CarouselView HeightRequest="180"
                              Loop="True"
                              IsBounceEnabled="True"
                              IndicatorView="bannerIndicators"
                              Margin="0,10,0,0">
                                <CarouselView.ItemsSource>
                                    <x:Array Type="{x:Type x:String}">
                                        <x:String>banner.jpeg</x:String>
                                        <x:String>banner.jpeg</x:String>
                                        <x:String>banner.jpeg</x:String>
                                    </x:Array>
                                </CarouselView.ItemsSource>

                                <CarouselView.ItemTemplate>
                                    <DataTemplate>
                                        <Image Aspect="AspectFill"
                   Source="{Binding}" />
                                    </DataTemplate>
                                </CarouselView.ItemTemplate>
                            </CarouselView>


                            <!-- Dots Indicator -->
                            <IndicatorView x:Name="bannerIndicators"
               IndicatorColor="LightGray"
               SelectedIndicatorColor="#FF5E00"
               HorizontalOptions="Center"
               Margin="0,5" />

                            <!-- Categories Section -->
                            <CollectionView ItemsSource="{Binding Categories}"
                ItemsLayout="HorizontalList"
                HeightRequest="150">

                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <!-- Frame takes exactly one child, so use StackLayout inside -->
                                        <Frame CornerRadius="15"
                   HasShadow="True"
                   Padding="10"
                   HeightRequest="120"
                   WidthRequest="100"
                   Margin="5">

                                            <VerticalStackLayout HorizontalOptions="Center"
                                     VerticalOptions="Center">
                                                <!-- Image fixed size -->
                                                <Image Source="{Binding ImageUrl.LocalImage}"
                           HeightRequest="50"
                           WidthRequest="50"/>

                                                <!-- Label wraps text, max 2 lines -->
                                                <Label Text="{Binding Name}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           LineBreakMode="WordWrap"
                           MaxLines="2"
                           FontSize="14"
                           HorizontalTextAlignment="Center"/>
                                            </VerticalStackLayout>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <Label Text="Latest Products"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   Margin="0,0"
                                   TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                        </VerticalStackLayout>
                    </CollectionView.Header>

                    <!-- Product Template -->
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                     Span="2"
                     HorizontalItemSpacing="10"
                     VerticalItemSpacing="10" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame HeightRequest="250"
               Padding="0"
               CornerRadius="15"
               HasShadow="True"
               Margin="0">
                                <Grid RowDefinitions="150,Auto,Auto,Auto">
                                    <Image Source="{Binding Images[0].Src, TargetNullValue='placeholder'}"
                       Aspect="AspectFill"
                       Grid.Row="0" />
                                    <Label Text="{Binding Name}"
                       Grid.Row="1"
                       Margin="10,5,10,0"
                       FontAttributes="Bold"
                       LineBreakMode="TailTruncation"
                       MaxLines="1"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                                    <Label Text="{Binding Price, StringFormat='â‚¹{0}'}"
                       Grid.Row="2"
                       Margin="10,0,10,0"
                       FontAttributes="Bold"
                       TextColor="#FF5E00" />
                                    <Button Text="Add to Cart"
        Grid.Row="3"
        Margin="10,5,10,10"
        BackgroundColor="#FF5E00"
        TextColor="White"
        CornerRadius="10"
        HorizontalOptions="Center"
        WidthRequest="120"
        HeightRequest="40"
        Clicked="OnAddToCartClicked"
        CommandParameter="{Binding .}" />

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>
            </ContentView>
        </RefreshView>

        <!-- Bottom navigation fixed -->
       
    </Grid>
</ContentPage>
