<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Watchzone.Views.ProductDetailPage"
             xmlns:local="clr-namespace:Watchzone.Views"
             xmlns:converters="clr-namespace:Watchzone.Converters"
             BackgroundColor="{AppThemeBinding Light=#f2f2f2, Dark=#1c1c1c}"
             Shell.TabBarIsVisible="False"
             Title="Product Details">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:RatingToStarsConverter x:Key="RatingToStarsConverter"/>
            <converters:CurrentCustomerReviewConverter x:Key="CurrentCustomerReviewConverter" />
            <converters:AddRatingConverter x:Key="AddRatingConverter"/>
            <converters:IsGreaterThanZeroConverter x:Key="IsGreaterThanZeroConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*, Auto">

        <!-- Scrollable Content -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0">

                <!-- Product Image Carousel -->
                <CarouselView HeightRequest="350"
                              IndicatorView="indicator"
                              ItemsSource="{Binding Product.Images}">
                    <CarouselView.ItemTemplate>
                        <DataTemplate>
                            <Image Source="{Binding Src}" 
                                   Aspect="AspectFill"
                                   BackgroundColor="LightGray"/>
                        </DataTemplate>
                    </CarouselView.ItemTemplate>
                </CarouselView>
                <IndicatorView x:Name="indicator"
                               IndicatorColor="LightGray"
                               SelectedIndicatorColor="{StaticResource Primary}"
                               HorizontalOptions="Center" Margin="0,5"/>

                <!-- Product Info Section -->
                <VerticalStackLayout Spacing="10"
                                     BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
                                     Padding="15">

                    <!-- Product Title -->
                    <Label Text="{Binding Product.Name}"
                           FontSize="22"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#222, Dark=White}"/>

                    <!-- Ratings -->
                    <HorizontalStackLayout Spacing="5">
                        <Image Source="star.png" HeightRequest="18" WidthRequest="18"/>
                        <Label Text="{Binding Product.AverageRating}" FontSize="14" FontAttributes="Bold"/>
                        <Label Text="{Binding Product.RatingCount, StringFormat='({0} ratings)'}"
                               FontSize="14" TextColor="Gray"/>
                    </HorizontalStackLayout>

                    <!-- Price -->
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding Product.RegularPrice, StringFormat='₹{0}'}"
                               FontSize="16"
                               TextDecorations="Strikethrough"
                               TextColor="Gray"
                               IsVisible="{Binding Product.OnSale}"/>
                        <Label Text="{Binding Product.SalePrice, StringFormat='₹{0}'}"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="Red"
                               IsVisible="{Binding Product.OnSale}"/>
                        <Label Text="{Binding Product.Price, StringFormat='₹{0}'}"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="Green"
                               IsVisible="{Binding Product.OnSale, Converter={StaticResource InverseBooleanConverter}}"/>
                    </HorizontalStackLayout>

                    <Label Text="Inclusive of all taxes" FontSize="12" TextColor="Gray"/>

                </VerticalStackLayout>

                <!-- Divider -->
                <BoxView HeightRequest="8" Color="#eeeeee"/>

                <!-- Offers Section -->
                <VerticalStackLayout Spacing="5"
                                     BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
                                     Padding="15">
                    <Label Text="Available Offers" FontSize="18" FontAttributes="Bold"/>
                    <Label Text="• Bank Offer: 10% Instant Discount on XYZ Bank Credit Cards"
                           FontSize="14" TextColor="Gray"/>
                    <Label Text="• Special Price: Get extra ₹500 off (price inclusive)"
                           FontSize="14" TextColor="Gray"/>
                </VerticalStackLayout>

                <!-- Divider -->
                <BoxView HeightRequest="8" Color="#eeeeee"/>

                <!-- Description -->
                <VerticalStackLayout Spacing="5"
                                     BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
                                     Padding="15">
                    <Label Text="Product Description" FontSize="18" FontAttributes="Bold"/>
                    <WebView VerticalOptions="FillAndExpand"
                            HorizontalOptions="FillAndExpand">
                        <WebView.Source>
                            <HtmlWebViewSource Html="{Binding Product.Description}" />
                        </WebView.Source>
                    </WebView>

                </VerticalStackLayout>
                <!-- Divider -->
                <BoxView HeightRequest="8" Color="#eeeeee"/>

                <!-- Rate & Review Section -->
                <VerticalStackLayout Padding="15" Spacing="16" BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}">
                    <Label Text="Rate this product" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light=#222, Dark=White}"/>

                    <!-- Star Rating with clearer visual feedback -->
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Tap a star to rate" FontSize="14" TextColor="Gray"/>
                        <HorizontalStackLayout Spacing="4" HorizontalOptions="Start">
                            <ImageButton Source="{Binding SelectedRating, Converter={StaticResource AddRatingConverter}, ConverterParameter=1}"
                         Command="{Binding SetRatingCommand}" CommandParameter="1"
                         WidthRequest="36" HeightRequest="36" BackgroundColor="Transparent"/>
                            <ImageButton Source="{Binding SelectedRating, Converter={StaticResource AddRatingConverter}, ConverterParameter=2}"
                         Command="{Binding SetRatingCommand}" CommandParameter="2"
                         WidthRequest="36" HeightRequest="36" BackgroundColor="Transparent"/>
                            <ImageButton Source="{Binding SelectedRating, Converter={StaticResource AddRatingConverter}, ConverterParameter=3}"
                         Command="{Binding SetRatingCommand}" CommandParameter="3"
                         WidthRequest="36" HeightRequest="36" BackgroundColor="Transparent"/>
                            <ImageButton Source="{Binding SelectedRating, Converter={StaticResource AddRatingConverter}, ConverterParameter=4}"
                         Command="{Binding SetRatingCommand}" CommandParameter="4"
                         WidthRequest="36" HeightRequest="36" BackgroundColor="Transparent"/>
                            <ImageButton Source="{Binding SelectedRating, Converter={StaticResource AddRatingConverter}, ConverterParameter=5}"
                         Command="{Binding SetRatingCommand}" CommandParameter="5"
                         WidthRequest="36" HeightRequest="36" BackgroundColor="Transparent"/>
                        </HorizontalStackLayout>
                        <Label Text="{Binding SelectedRating, StringFormat='Your rating: {0} star(s)'}" 
               FontSize="14" TextColor="#ff9f00" 
               IsVisible="{Binding SelectedRating, Converter={StaticResource IsGreaterThanZeroConverter}}"/>
                    </VerticalStackLayout>

                    <!-- Review Text -->
                    <VerticalStackLayout Spacing="6">
                        <Label Text="Your review" FontSize="16" FontAttributes="Bold" TextColor="{AppThemeBinding Light=#222, Dark=White}"/>
                        <Editor x:Name="ReviewEditor"
                Placeholder="Share details of your own experience with this product..."
                AutoSize="TextChanges"
                HeightRequest="120"
                FontSize="14"
                BackgroundColor="{AppThemeBinding Light=#f9f9f9, Dark=#333}"
                TextColor="{AppThemeBinding Light=#222, Dark=White}"/>
                        <Label Text="{Binding Source={x:Reference ReviewEditor}, Path=Text.Length, StringFormat='{0}/500'}" 
               HorizontalOptions="End" FontSize="12" TextColor="Gray"/>
                    </VerticalStackLayout>

                    <!-- Submit Button -->
                    <Button Text="Submit Review"
            BackgroundColor="{AppThemeBinding Light=#ff9f00, Dark=#ffa733}"
            TextColor="White"
            FontSize="16"
            CornerRadius="5"
            HeightRequest="44"
            FontAttributes="Bold"
            Clicked="OnSubmitReviewClicked"/>
                </VerticalStackLayout>

                <!-- Divider -->
                <BoxView HeightRequest="8" Color="#eeeeee"/>

                <!-- Reviews -->
                <VerticalStackLayout Spacing="10"
                     BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
                     Padding="15">
                    <Label Text="Customer Reviews" FontSize="18" FontAttributes="Bold"/>

                    <CollectionView ItemsSource="{Binding Reviews}" 
                    EmptyView="No reviews yet."
                    Margin="0,5,0,0">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="15"/>
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="10" Margin="0,0,0,0"
                       HasShadow="False"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
                       BorderColor="#ddd"
                       CornerRadius="8">

                                    <VerticalStackLayout Spacing="5">

                                        <!-- Name (left) + Date (right) -->
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding Reviewer}"
                                   FontAttributes="Bold"
                                   FontSize="14"
                                   TextColor="Black"
                                   Grid.Column="0"/>

                                            <Label Text="{Binding Date, StringFormat='{0:dd MMM yyyy}'}"
                                   FontSize="12"
                                   TextColor="Gray"
                                   Grid.Column="1"/>
                                        </Grid>

                                        <!-- ⭐ Rating Stars -->
                                        <CollectionView ItemsSource="{Binding Rating, Converter={StaticResource RatingToStarsConverter}}"
                                        ItemsLayout="HorizontalList"
                                        HeightRequest="20"
                                        Margin="0,2,0,0"
                                        SelectionMode="None">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Image Source="{Binding .}" HeightRequest="16" WidthRequest="16"/>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <!-- Review text -->
                                        <Label Text="{Binding ReviewText}" FontSize="14"/>
                                        <Button Text="Delete"
        FontSize="12"
        TextColor="Red"
        BackgroundColor="Transparent"
        HorizontalOptions="End"
        Command="{Binding Source={RelativeSource AncestorType={x:Type local:ProductDetailPage}}, Path=BindingContext.DeleteReviewCommand}"
        CommandParameter="{Binding .}"
        IsVisible="{Binding Reviewer, Converter={StaticResource CurrentCustomerReviewConverter}}"/>

                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>



            </VerticalStackLayout>
        </ScrollView>

        <!-- Fixed Bottom Buttons -->
        <Grid Grid.Row="1"
      ColumnDefinitions="*,*"
      ColumnSpacing="12"
      BackgroundColor="{AppThemeBinding Light=White, Dark=#2b2b2b}"
      Padding="10"
      HeightRequest="80">

            <!-- Add to Cart -->
            <Button Text="Add to Cart"
            Grid.Column="0"
            BackgroundColor="Orange"
            TextColor="White"
            CornerRadius="8"
            FontAttributes="Bold"
            HeightRequest="50"
            VerticalOptions="Center"
            HorizontalOptions="FillAndExpand"
            CommandParameter="{Binding Product}"
            Clicked="OnAddToCartClicked"/>

            <!-- Buy Now -->
            <Button Text="Buy Now"
            Grid.Column="1"
            BackgroundColor="Green"
            TextColor="White"
            CornerRadius="8"
            FontAttributes="Bold"
            HeightRequest="50"
            VerticalOptions="Center"
            HorizontalOptions="FillAndExpand"
            CommandParameter="{Binding Product}"
            Clicked="OnBuyNowClicked"/>
        </Grid>


    </Grid>
</ContentPage>
